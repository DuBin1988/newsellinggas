<UserControl
	xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:a="clr-namespace:Com.Aote.Attachs;assembly=s2DLL"
    xmlns:o="clr-namespace:Com.Aote.ObjectTools;assembly=s2DLL"
    xmlns:b="clr-namespace:Com.Aote.Behaviors;assembly=s2DLL"
    xmlns:m="clr-namespace:Com.Aote.Marks;assembly=s2DLL"
    xmlns:c="clr-namespace:Com.Aote.Controls;assembly=s2DLL"
    xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
    xmlns:ei="http://schemas.microsoft.com/expression/2010/interactions"
    xmlns:data="clr-namespace:System.Windows.Data;assembly=System.Windows"
    xmlns:sdk="http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk"
    xmlns:toolkit="http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit" 
	mc:Ignorable="d"
	x:Class="Com.Aote.Pages.交费通知单">
    <Grid x:Name="LayoutRoot">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="10*"/>
                <ColumnDefinition Width="0*"/>
            </Grid.ColumnDefinitions>
            <c:BusyIndicatorEx BusyContent="正在查询，请稍等" IsBusy="{m:Exp Str=daninfos.ItemsSource.IsBusy}">
                <toolkit:DockPanel>
                    <Grid x:Name="daninfosearch" toolkit:DockPanel.Dock="Top" Height="Auto" Width="Auto" Background="#FFF7F7F7">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="30"/>
                            <RowDefinition Height="30"/>
                            <RowDefinition Height="30"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>
                        <a:Data.Context>
                            <o:SearchObject />
                        </a:Data.Context>
                        <TextBlock TextWrapping="Wrap" Margin="0" Height="25" TextAlignment="Right" Text="用户编号：" Grid.Row="1"/>
                        <TextBox Text="{m:Bind Path=f_userid}" Width="Auto" Margin="0" Height="25" HorizontalAlignment="Stretch" Grid.Column="1" Grid.ColumnSpan="1" Grid.RowSpan="1" Grid.Row="1" >
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_userid" Operator="f_userid >= this"/>
                            </a:Data.Prop>
                        </TextBox>
                        <StackPanel Grid.ColumnSpan="8" Margin="0,0,3,0" Orientation="Horizontal" Grid.RowSpan="3" d:LayoutOverrides="Width" Grid.Row="2" Grid.Column="7">
                            <Button Content=" 查  询" x:Name="dansearchbutton" Click="{m:Exp Str=daninfosearch.DataContext.Search()}" FontSize="14"  Width="60" Height="30" VerticalAlignment="Bottom" RenderTransformOrigin="0.483,0.679"  />
                            <Button Content=" 置  空" Click="{m:Exp Str=daninfosearch.DataContext.f_districtname\=null;daninfosearch.DataContext.f_handdate\=null;daninfosearch.DataContext.f_handdate1\=null;daninfosearch.DataContext.f_userid\=null;daninfosearch.DataContext.f_username\=null;daninfosearch.DataContext.f_usertype\=null;daninfosearch.DataContext.f_inputtor\=null;daninfosearch.DataContext.f_menzhan\=null;daninfosearch.DataContext.f_zerenbumen\=null}" FontSize="14" HorizontalAlignment="Right" Width="60" Height="30" VerticalAlignment="Bottom"  />
                            <Button Content=" 打  印" Click="{m:Exp Str=print1.Print()}" Height="30" VerticalAlignment="top" Width="60"/>
                        </StackPanel>
                        <TextBlock TextWrapping="Wrap" Margin="0,2,0,3" Height="25" TextAlignment="Right" Text="小区名称"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,3,0,2" Height="25" TextAlignment="Right" Text="计划截止月份：" Grid.Column="2"/>
                        <TextBlock TextWrapping="Wrap" Margin="0" Height="25" TextAlignment="Right" Text="到：" Grid.Row="1" Grid.Column="2"/>
                        <TextBox Text="{m:Bind Path=f_userid2}" Width="Auto" Margin="0" Height="25" HorizontalAlignment="Stretch" Grid.Column="3" Grid.ColumnSpan="1" Grid.RowSpan="1" Grid.Row="1" >
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_userid2" Operator="f_userid ^= this"/>
                            </a:Data.Prop>
                        </TextBox>
                        <TextBlock TextWrapping="Wrap" Margin="0" Height="25" TextAlignment="Right" Text="用户类型：" Grid.Row="1" Grid.Column="4"/>
                        <TextBlock TextWrapping="Wrap" Margin="0" Height="25" TextAlignment="Right" Text="抄表员：" Grid.Row="2" d:LayoutOverrides="VerticalAlignment"/>
                        <TextBlock TextWrapping="Wrap" Margin="0,2,0,3" Height="25" TextAlignment="Right" Text="用户姓名：" Grid.Column="2" Grid.Row="2"/>
                        <TextBlock TextWrapping="Wrap" Margin="0" Height="25" TextAlignment="Right" Text="责任部门：" Grid.Column="4" Grid.Row="2"/>
                        <TextBlock TextWrapping="Wrap" Margin="0" Height="25" TextAlignment="Right" Text="录入员：" Grid.Column="4" />
                        <TextBox Text="{m:Bind Path=f_username}" Width="Auto" Margin="0" Height="25" HorizontalAlignment="Stretch" Grid.Column="3" Grid.ColumnSpan="1" Grid.RowSpan="1" Grid.Row="2" >
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_username" Operator="f_username='this'"/>
                            </a:Data.Prop>
                        </TextBox>
                        <ComboBox x:Name="CoboxPinp_Copy1"  DisplayMemberPath="name" SelectedValuePath="name" ItemsSource="{m:Exp Str=usertypelistnull}" SelectedValue="{m:Bind Path=f_usertype}" Grid.Column="5" Margin="0,4,0,1" Height="25" IsEnabled="true" FontSize="13.333" Grid.Row="1">
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_usertype" Operator="f_usertype = 'this'"/>
                            </a:Data.Prop>
                        </ComboBox>

                        <ComboBox x:Name="CoboxPinp_Copy3" ItemsSource="{m:Exp Str=chaobiaoyuanlistnull}" SelectedValuePath="name" SelectedValue="{m:Bind Path=f_inputtor}" Grid.Column="1" Margin="0" Grid.Row="2" Height="25" IsEnabled="true" Grid.ColumnSpan="1" FontSize="13.333">
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_inputtor" Operator="f_inputtor='this'"/>
                            </a:Data.Prop>
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Height="20" Text="{Binding name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <ComboBox x:Name="CoboxPinp_Copy5" ItemsSource="{m:Exp Str=czylistnull}" SelectedValuePath="name" SelectedValue="{m:Bind Path=f_operator}" Grid.Column="5" Margin="0"  Height="25" IsEnabled="true" Grid.ColumnSpan="1" FontSize="13.333" >
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_operator" Operator="f_operator='this'"/>
                            </a:Data.Prop>
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Height="20" Text="{Binding name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <ComboBox ItemsSource="{m:Exp Str=zerenbumenlistnull}"
									SelectedValuePath="name" SelectedValue="{m:Bind Path=f_zerenbumen}"  x:Name="CoboxPinp_Copy4" Grid.Column="5" Margin="0,3,0,2" Grid.Row="2" Height="25" IsEnabled="true" VerticalAlignment="Stretch" FontSize="13.333">
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_zerenbumen" Operator="f_zerenbumen='this'"/>
                            </a:Data.Prop>
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Height="20" Text="{Binding name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <!--sdk:DatePicker SelectedDate="{m:Bind Path=f_enddate}"  Width="Auto" Margin="0,3,0,2" Height="25" HorizontalAlignment="Stretch" Grid.Column="3" Grid.ColumnSpan="1" Grid.RowSpan="1" Grid.Row="0" VerticalAlignment="Stretch" >
									<a:Data.Prop>
										<o:PropertySetter PropertyName="f_enddate" Value="{m:Exp Str=SysTime.Today}"
										Operator=" f_deliverydate ^= substring('this',1,10)"/>
									</a:Data.Prop>
								</sdk:DatePicker-->
                        <c:Month SelectedDate="{m:Bind Path=f_handdate}" StringFormat="yyyyMM" Width="Auto" Margin="0,3,0,2" Height="25" HorizontalAlignment="Stretch" Grid.Column="3" Grid.ColumnSpan="1" Grid.RowSpan="1" Grid.Row="0" VerticalAlignment="Stretch" >
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_handdate" NoDependValue="{m:Exp Str=SysTime.Today}"
										Operator="{m:Exp Str=$substring(convert(varchar(50)\,f_handdate\,112)\,1\,6) \=\'\{this.f_handdate.ToString($yyyyMM$)\}\'}"/>
                            </a:Data.Prop>
                        </c:Month>
                        <TextBox Text="{m:Bind Path=f_districtname}" Width="Auto" Margin="0,2,0,3" Height="25" HorizontalAlignment="Stretch" Grid.Column="1" Grid.ColumnSpan="1" Grid.RowSpan="1" Grid.Row="0" >
                            <a:Data.Prop>
                                <o:PropertySetter PropertyName="f_districtname" Operator="f_districtname like '%this%'"/>
                            </a:Data.Prop>
                        </TextBox>

                    </Grid>
                    <Grid   Background="#FFC3E4FD" toolkit:DockPanel.Dock="Bottom">
                        <sdk:DataPager x:Name="pager2" Source="{Binding ItemsSource.Count, Converter={StaticResource DataPagerConverter}, ElementName=daninfos}" Margin="0" PageSize="23" d:LayoutOverrides="Width"   />
                        <StackPanel HorizontalAlignment="Left" Orientation="Horizontal">
                            <TextBlock TextWrapping="NoWrap" Text="{m:Exp Str=$共\{daninfos.ItemsSource.Count\}项，每页\{daninfos.ItemsSource.PageSize\}行}"/>
                        </StackPanel>
                    </Grid>

                    <sdk:DataGrid x:Name="daninfos" Margin="0,0,0,3"   IsReadOnly="True"
								AutoGenerateColumns="False" Width="Auto" Background="{x:Null}" >
                        <a:Data.Items>
                            <!--substring(convert(varchar(50)\,f_handdate\,112)\,1\,6)\=\'201403\'   substring(convert(varchar(50)\,f_handdate\,112)\,1\,6)\=\'201403\'-->
                            <o:PagedList x:Name="daninfoslist" WebClientInfo="{StaticResource dbclient}"
									
									SumHQL="{m:Exp Str=$ 
select u.f_userid\,u.f_username\,u.f_districtname+u.f_apartment address\,u.f_phone\,
h.lastinputgasnum\,h.lastrecord\,h.oughtamount\,h.oughtfee\,(ISNULL(s.lastfee1\,0)+ISNULL(s1.lastfee2\,0)+ISNULL(g.f_zhinajin\,0)) lastfee\,
isnull(g.f_zhye\,u.f_zhye) zhye\,(case h.shifoujiaofei when \'是\' then convert(numeric(18\,2)\,u.f_zhye+h.oughtfee-g.f_zhye+ISNULL(s.lastfee1\,0)+ISNULL(s1.lastfee2\,0)+ISNULL(g.f_zhinajin\,0)) else isnull(g.f_grossproceeds\,0) end )benqipayfee\,(case h.shifoujiaofei when \'是\' then u.f_zhye else convert(decimal(18\,2)\,u.f_zhye+isnull(g.f_grossproceeds\,0)-h.oughtfee-ISNULL(s.lastfee1\,0)-ISNULL(s1.lastfee2\,0)-ISNULL(g.f_zhinajin\,0)) end )benqizhye\,
h.f_inputtor\,h.f_zerenbumen
FROM
( SELECT f_sellid\,f_userid\,lastinputgasnum\,lastrecord\,oughtamount\,
oughtfee\,f_inputtor\,f_zerenbumen\,shifoujiaofei
FROM t_handplan
WHERE f_state\=\'已抄表\' AND \{daninfosearch.DataContext.Condition\}  )h
left join (
select f_userid \,SUM(oughtfee) lastfee1
from t_handplan
where f_state\=\'已抄表\' and shifoujiaofei\=\'否\'and SUBSTRING(CONVERT(varchar(20)\, f_handdate\,112)\,1\,6)^\{daninfosearch.DataContext.f_handdate.ToString($yyyyMM$)\}
group by f_userid)s on h.f_userid\=s.f_userid
left join(
select f_userid\,f_sellid\,SUM(oughtfee) lastfee2
from t_handplan
where SUBSTRING(CONVERT(varchar(20)\, f_handdate\,112)\,1\,6)^\{daninfosearch.DataContext.f_handdate.ToString($yyyyMM$)\}
group by f_userid\,f_sellid)s1 on h.f_sellid\=s1.f_sellid
left join
(select id\,f_grossproceeds\,f_zhinajin\,f_zhye from t_sellinggas) g on  h.f_sellid\=g.id 
left JOIN t_userfiles u ON u.f_userid\=h.f_userid  
}"
									HQL="{m:Exp Str=$
select u.f_userid\,u.f_username\,u.f_districtname+u.f_apartment address\,u.f_phone\,
h.lastinputgasnum\,h.lastrecord\,h.oughtamount\,h.oughtfee\,(ISNULL(s.lastfee1\,0)+ISNULL(s1.lastfee2\,0)+ISNULL(g.f_zhinajin\,0)) lastfee\,
isnull(g.f_zhye\,u.f_zhye) zhye\,(case h.shifoujiaofei when \'是\' then convert(numeric(18\,2)\,u.f_zhye+h.oughtfee-g.f_zhye+ISNULL(s.lastfee1\,0)+ISNULL(s1.lastfee2\,0)+ISNULL(g.f_zhinajin\,0)) else isnull(g.f_grossproceeds\,0) end )benqipayfee\,(case h.shifoujiaofei when \'是\' then u.f_zhye else convert(decimal(18\,2)\,u.f_zhye+isnull(g.f_grossproceeds\,0)-h.oughtfee-ISNULL(s.lastfee1\,0)-ISNULL(s1.lastfee2\,0)-ISNULL(g.f_zhinajin\,0)) end )benqizhye\,
h.f_inputtor\,h.f_zerenbumen
FROM
( SELECT f_sellid\,f_userid\,lastinputgasnum\,lastrecord\,oughtamount\,
oughtfee\,f_inputtor\,f_zerenbumen\,shifoujiaofei
FROM t_handplan
WHERE f_state\=\'已抄表\' AND \{daninfosearch.DataContext.Condition\}  )h
left join (
select f_userid \,SUM(oughtfee) lastfee1
from t_handplan
where f_state\=\'已抄表\' and shifoujiaofei\=\'否\'and SUBSTRING(CONVERT(varchar(20)\, f_handdate\,112)\,1\,6)^\{daninfosearch.DataContext.f_handdate.ToString($yyyyMM$)\}
group by f_userid)s on h.f_userid\=s.f_userid
left join(
select f_userid\,f_sellid\,SUM(oughtfee) lastfee2
from t_handplan
where SUBSTRING(CONVERT(varchar(20)\, f_handdate\,112)\,1\,6)^\{daninfosearch.DataContext.f_handdate.ToString($yyyyMM$)\}
group by f_userid\,f_sellid)s1 on h.f_sellid\=s1.f_sellid
left join
(select id\,f_grossproceeds\,f_zhinajin\,f_zhye from t_sellinggas) g on  h.f_sellid\=g.id 
left JOIN t_userfiles u ON u.f_userid\=h.f_userid  
 order by h.f_userid
}"
									Path="sql" PageIndex="{m:Exp Str=pager2.PageIndex}" PageSize="{m:Exp Str=pager2.PageSize}" SumNames=","/>
                        </a:Data.Items>
                        <sdk:DataGrid.Columns>
                            <sdk:DataGridTextColumn Header="用户编号" Binding="{Binding f_userid}"/>
                            <sdk:DataGridTextColumn Header="用户姓名" Binding="{Binding f_username}"/>
                            <sdk:DataGridTextColumn Header="地址" Binding="{Binding address}"/>
                            <sdk:DataGridTextColumn Header="电话" Binding="{Binding f_phone}"/>
                            <sdk:DataGridTextColumn Header="上次底数" Binding="{Binding lastinputgasnum}"/>
                            <sdk:DataGridTextColumn Header="本次底数" Binding="{Binding lastrecord}"/>
                            <sdk:DataGridTextColumn Header="本次气量" Binding="{Binding oughtamount}"/>
                            <sdk:DataGridTextColumn Header="本次气量金额" Binding="{Binding oughtfee}"/>
                            <sdk:DataGridTextColumn Header="往月欠费" Binding="{Binding lastfee}"/>
                            <sdk:DataGridTextColumn Header="上期账户余额" Binding="{Binding zhye}"/>
                            <sdk:DataGridTextColumn Header="本期交费" Binding="{Binding benqipayfee}"/>
                            <sdk:DataGridTextColumn Header="本期账户余额" Binding="{Binding benqizhye}"/>
                            <sdk:DataGridTextColumn Header="抄表员" Binding="{Binding f_inputtor}"/>
                            <sdk:DataGridTextColumn Header="责任部门" Binding="{Binding f_zerenbumen}"/>
                        </sdk:DataGrid.Columns>
                    </sdk:DataGrid>
                </toolkit:DockPanel>
            </c:BusyIndicatorEx>

        </Grid>



        <c:PrintPageObj x:Name="print1" ListNameInArea="selllist" Area="{m:Res Key=sqprint1}" 
      List="{m:Exp Str=daninfos.ItemsSource}" PageRow="23"  />

        <Grid  x:Name="sqprint1" VerticalAlignment="Bottom" Margin="-1355,0,0,25" HorizontalAlignment="Left" Width="auto"  Height="615">

            <sdk:DataGrid x:Name="selllist" AutoGenerateColumns="False" Style="{StaticResource DataGridPrintStyle}" FontSize="11"  Grid.Row="1" VerticalAlignment="Top" >
                <sdk:DataGrid.Columns>
                    <sdk:DataGridTemplateColumn Header=" " d:IsLocked="True" >
                        <sdk:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBox Text="     "   IsReadOnly="True"/>
                            </DataTemplate>
                        </sdk:DataGridTemplateColumn.CellTemplate>
                    </sdk:DataGridTemplateColumn>
                    <sdk:DataGridTextColumn Header="用户编号" Binding="{Binding f_userid}"/>
                    <sdk:DataGridTextColumn Header="用户姓名" Binding="{Binding f_username}"/>
                    <sdk:DataGridTextColumn Header="地址" Binding="{Binding address}" Width="200"/>
                    <sdk:DataGridTextColumn Header="电话" Binding="{Binding f_phone}"/>
                    <sdk:DataGridTextColumn Header="上次底数" Binding="{Binding lastinputgasnum}"/>
                    <sdk:DataGridTextColumn Header="本次底数" Binding="{Binding lastrecord}"/>
                    <sdk:DataGridTextColumn Header="本次气量" Binding="{Binding oughtamount}"/>
                    <sdk:DataGridTextColumn Header="本次气量金额" Binding="{Binding oughtfee}"/>
                    <sdk:DataGridTextColumn Header="往月欠费" Binding="{Binding lastfee}"/>
                    <sdk:DataGridTextColumn Header="上期账户余额" Binding="{Binding zhye}"/>
                    <sdk:DataGridTextColumn Header="本期交费" Binding="{Binding benqipayfee}"/>
                    <sdk:DataGridTextColumn Header="本期账户余额" Binding="{Binding benqizhye}"/>
                    <sdk:DataGridTextColumn Header="抄表员" Binding="{Binding f_inputtor}"/>
                    <sdk:DataGridTextColumn Header="责任部门" Binding="{Binding f_zerenbumen}"/>
                </sdk:DataGrid.Columns>
            </sdk:DataGrid>

        </Grid>


    </Grid>
</UserControl>