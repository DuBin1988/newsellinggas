<UserControl
	xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:a="clr-namespace:Com.Aote.Attachs;assembly=s2DLL"
    xmlns:o="clr-namespace:Com.Aote.ObjectTools;assembly=s2DLL"
    xmlns:oo="clr-namespace:Com.Aote.ObjectTools"
    xmlns:b="clr-namespace:Com.Aote.Behaviors;assembly=s2DLL"
	xmlns:c="clr-namespace:Com.Aote.Controls;assembly=s2DLL"
    xmlns:m="clr-namespace:Com.Aote.Marks;assembly=s2DLL"
    xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
    xmlns:ei="http://schemas.microsoft.com/expression/2010/interactions"
    xmlns:data="clr-namespace:System.Windows.Data;assembly=System.Windows"
    xmlns:sdk="http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk"
    xmlns:toolkit="http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit"
	mc:Ignorable="d" FontSize="13"
	x:Class="s2.街道管理"
	d:DesignWidth="640" d:DesignHeight="480">

    <Grid x:Name="LayoutRoot" Background="#FFDBE4F3">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.4*"/>
            <ColumnDefinition Width="0.4*"/>
        </Grid.ColumnDefinitions>
        <m:ResourceLoad x:Name="loader">
            <!--街道资源
        	<o:GeneralObject Name="road" EntityType="t_road" WebClientInfo="{StaticResource dbclient}"
                  Path="{m:Exp Str=$one/from t_road where id \= \{roadid.f_flownum\} and f_daofanwei &gt; \{kbusers.f_flownum\}}">
			</o:GeneralObject>-->

            <!--<o:GeneralObject Name="roadmanege1" EntityType="t_road" WebClientInfo="{StaticResource dbclient}"
              IsInit="{m:Exp Str=SaveAction.State\=\=$End$}">
			</o:GeneralObject>-->
            <!--<o:GeneralObject Name="roadsave" EntityType="t_road" WebClientInfo="{StaticResource dbclient}">
			<o:PropertySetter PropertyName="f_road" NoDependValue="{m:Exp Str=SaveAction\=>Saving!\=null:roadmanege.f_road\,null}"/>
			<o:PropertySetter PropertyName="f_operatedate" NoDependValue="{m:Exp Str=SaveAction\=>Saving!\=null:roadmanege.f_operatedate\,null}"/>
			<o:PropertySetter PropertyName="f_operatestation" NoDependValue="{m:Exp Str=SaveAction\=>Saving!\=null:roadmanege.f_operatestation\,null}"/>
			<o:PropertySetter PropertyName="f_operator" NoDependValue="{m:Exp Str=SaveAction\=>Saving!\=null:roadmanege.f_operator\,null}"/>
			</o:GeneralObject>-->

            <o:ObjectList Name="SecondStairlist" EntityType="t_organization" WebClientInfo="{StaticResource dbclient}"  Path="{m:Exp Str=LoginUser.character >\= 2:$from t_organization where NAME\=\'\{LoginUser.orgpathstr.Split($.$\,1)\}\'$\,$from t_organization where f_parentname\=\'\{roadmanege.DataContext.FirstStair\}\'$}" />
            <o:ObjectList Name="ThirdStairStairlist" EntityType="t_organization" WebClientInfo="{StaticResource dbclient}"  Path="{m:Exp Str=LoginUser.character >\= 3:$from t_organization where NAME\=\'\{LoginUser.orgpathstr.Split($.$\,2)\}\'$\,$from t_organization where f_parentname\=\'\{roadmanege.DataContext.SecondStair\}\'$}" />
            <o:ObjectList Name="FourthStairlist"  WebClientInfo="{StaticResource dbclient}"  Path="{m:Exp Str=LoginUser.character >\= 4:$from t_organization where NAME\=\'\{LoginUser.orgpathstr.Split($.$\,3)\}\'$\,$from t_organization where f_parentname\=\'\{roadmanege.DataContext.ThirdStair\}\'$}" />



            <!--判断小区名称是否存在-->
            <o:GeneralObject Name="roadexist" EntityType="t_road" WebClientInfo="{StaticResource dbclient}" 
		  	Path="{m:Exp Str=roadmanege.DataContext.f_road \!\=null:$one/select new Map(count(*) as count) from t_road where f_road\=\'\{roadmanege.DataContext.f_road\}\'$\,$aaa$}" 
			IsInit="{m:Exp Str=roadmanege.DataContext.State\=\=$End$ }">
            </o:GeneralObject>
            <!--街道编号-->
            <o:SeriaNumber Name="roadid" Length="5"  Key="{m:Exp Str='$A{SysTime.Now.ToString($yyyy$)}'}"/>
            <!--总公司名称-->
            <o:GeneralObject Name="zonggongsi" EntityType="t_singlevalue" WebClientInfo="{StaticResource dbclient}" 
		  		Path="{m:Exp Str=$one/from t_singlevalue where name \= \'总公司名称\'}"   >
            </o:GeneralObject>
            <b:HQLAction Name="DeleteAction"  WebClientInfo="{StaticResource dbclient}" 
			HQL="{m:Exp Str=$delete from t_road where ID \= \'\{roads.SelectedItems.ToString(ID)\=>SelectionChanged\}\'}">
            </b:HQLAction>

            <b:BatchExcuteAction Name="SaveAction" WebClientInfo="{StaticResource dbclient}">
                <!--b:BatchInfo Source="{m:Exp Str=ksnumobj}" MethodName="SaveToJson"/-->
                <b:BatchInfo Source="{m:Exp Str=roadmanege.DataContext}" MethodName="SaveToJson"/>
            </b:BatchExcuteAction>
        </m:ResourceLoad>

        <c:BusyIndicatorEx BusyContent="正在工作，请稍等" IsBusy="{m:Exp Str=roadmanege.DataContext.IsBusy or SaveAction.IsBusy}">

            <toolkit:DockPanel  x:Name="roadmanege" Margin="0,0,10,0" HorizontalAlignment="Stretch">
                <a:Data.Context>
                    <o:GeneralObject Name="roadItem" WebClientInfo="{StaticResource dbclient}" 
		EntityType="t_road" Source="{m:Exp Str=roads.SelectedItem}"
		IsInit="{m:Exp Str='this.State\=\=$End$ |or| DeleteAction.State \=\= $End$ |or| SaveAction.State \=\= $End$'}"/>

                </a:Data.Context>
                <Grid Background="#FFDBE4F3">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="30"/>

                        <RowDefinition Height="30"/>

                        <RowDefinition Height="30"/>
                        <RowDefinition Height="30"/>
                        <RowDefinition Height="32*"/>
                        <RowDefinition Height="37*"/>
                        <RowDefinition Height="42*"/>
                        <RowDefinition Height="129*"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="100"/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Width="auto" Orientation="Horizontal" VerticalAlignment="bottom" Grid.ColumnSpan="2" Margin="1,0,0,0" Grid.Row="9" HorizontalAlignment="stretch" Grid.Column="0">
                        <Button Content="保存" x:Name="save" Margin="60,0,0,0" IsEnabled="{m:Exp Str=!roadmanege.DataContext.HasErrors}" Click="{m:Exp Str=SaveAction.Invoke()}" Width="70" HorizontalAlignment="Left"  Height="30" d:LayoutOverrides="Height, GridBox"  />
                        <Button Content="新建" x:Name="save_Copy"  Click="{m:Exp Str=roadmanege.DataContext.New()}" Width="70" HorizontalAlignment="center" Margin="6,0,0,0" Height="30" d:LayoutOverrides="Height"  />
                        <Button Content="删除" x:Name="delete" IsEnabled="{m:Exp Str=roads.SelectedItem!\=null}" Click="{m:Exp Str=DeleteAction.Invoke()}" Width="70" HorizontalAlignment="Right" Margin="6,0,0,0" VerticalAlignment="Stretch" Height="30" d:LayoutOverrides="Height"  />
                    </StackPanel>
                    <TextBlock Text="街道名称：" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,6,0,5"/>
                    <TextBlock Text="街道范围：" HorizontalAlignment="Right" VerticalAlignment="Center" Grid.Row="1" Margin="0,6,0,5" />
                    <TextBlock Text="操作日期：" HorizontalAlignment="Right" VerticalAlignment="Center" Grid.Row="4" Margin="0,6,0,5"/>
                    <TextBlock Text="操 作 员：" HorizontalAlignment="Right" VerticalAlignment="Center" Grid.Row="3" Margin="0,6,0,5" />
                    <TextBox Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="1" Text="{m:Bind Path=f_road}" Margin="0,2,0,1" VerticalAlignment="Center" Grid.RowSpan="1" Width="200" HorizontalAlignment="Left">
                        <a:Data.Prop>
                            <o:PropertySetter PropertyName="f_road" NotNull="True" ValidationVal="{m:Exp Str=roadexist.count&gt;0:$False$\,$True$}" ErrorMessage="街道名称已存在" />
                            <!---->
    		</a:Data.Prop>
			</TextBox>
			<!--
			<TextBox Text="{m:Bind Path=f_roadnum}" IsReadOnly="True" Grid.Column="3" Margin="0,0,11,0"  Grid.Row="1" TextWrapping="Wrap"  HorizontalAlignment="right" VerticalAlignment="Top" Height="25" FontSize="13.333" Width="4" d:LayoutOverrides="Height" Grid.RowSpan="1" >
					<a:Data.Prop>
						<o:PropertySetter PropertyName="f_roadnum"   Validation="{m:Exp Str=value \=\= 0 }"  Value="{m:Exp Str=roadexist.count}"  ErrorMessage="街道名称已存在"/>
					</a:Data.Prop>
			</TextBox>-->
                            <TextBox Text="{m:Bind Path=f_operatedate}" IsReadOnly="True" Grid.Column="1" Margin="0,3,0,2" Grid.Row="4" VerticalAlignment="Stretch" Height="25" Grid.RowSpan="1" HorizontalAlignment="Left" Width="200" >
                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="f_operatedate" NotNull="True" 
    								Default="{m:Exp Str=SysTime.Today.ToString($yyyy-MM-dd$)}"/>
                                </a:Data.Prop>
                            </TextBox>
                            <TextBox Grid.Row="3" IsReadOnly="True" Grid.Column="1" Text="{m:Bind Path=f_operator}" VerticalAlignment="Center" Margin="0,2,0,1" Grid.RowSpan="1" Grid.ColumnSpan="1" HorizontalAlignment="Left" Width="200">
                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="f_operator"  
						Default="{m:Exp Str=LoginUser.name}"/>
                                </a:Data.Prop>
                            </TextBox>
                            <TextBox Grid.Row="1" IsReadOnly="False" Grid.Column="1" Text="{m:Bind Path=f_roadrange}" VerticalAlignment="Center" Margin="0,2,0,1" Grid.RowSpan="1" Grid.ColumnSpan="1" HorizontalAlignment="Left" Width="200">
                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="f_roadrange" />
                                </a:Data.Prop>
                            </TextBox>
                            <TextBlock TextWrapping="Wrap" Text="总公司：" Grid.Column="0" Grid.Row="5"  Height="25" TextAlignment="Right" Margin="0,3,0,2"/>
                            <TextBox Name="FirstStair" TextWrapping="Wrap" Grid.Row="5" Grid.Column="1" Text="{m:Bind Path=FirstStair}" IsEnabled="False"  Width="Auto" Margin="0,3,0,2" Height="25" HorizontalAlignment="Stretch" >
                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="FirstStair"  Default="{m:Exp Str=roadmanege.DataContext.FirstStair}"  NoDependValue="{m:Exp Str= zonggongsi.value}" NotNull="True"/>
                                </a:Data.Prop>
                            </TextBox>
                            <TextBlock TextWrapping="Wrap" Text="二级总公司：" Grid.Column="0" Grid.Row="6"  Height="25" TextAlignment="Right" Margin="0,3,0,2"/>
                            <ComboBox x:Name="SecondStair"  IsEnabled="{m:Exp Str=LoginUser.character ^ 2}"  SelectedValue="{m:Bind Path=SecondStair}" Grid.Row="6" Grid.Column="1" ItemsSource="{m:Exp Str=SecondStairlist}" DisplayMemberPath="name" SelectedValuePath="name"  Margin="0,3,0,2" Height="25" HorizontalAlignment="Stretch" Width="Auto">
                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="SecondStair"/>
                                </a:Data.Prop>
                            </ComboBox>
                            <TextBlock TextWrapping="Wrap" Text="三级总公司：" Grid.Column="0" Grid.Row="7"  Height="25" TextAlignment="Right" Margin="0,3,0,2"/>
                            <ComboBox x:Name="ThirdStair" IsEnabled="{m:Exp Str=LoginUser.character ^ 3}" SelectedValue="{m:Bind Path=ThirdStair}" Grid.Row="7" Grid.Column="1" ItemsSource="{m:Exp Str=ThirdStairStairlist}"  Margin="0,3,0,2" DisplayMemberPath="name" SelectedValuePath="name"  Height="25" HorizontalAlignment="Stretch" Width="Auto">

                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="ThirdStair" />
                                </a:Data.Prop>
                            </ComboBox>
                            <TextBlock TextWrapping="Wrap" Text="四级总公司：" Grid.Column="0" Grid.Row="8"  Height="25" TextAlignment="Right" Margin="0,3,0,2"/>
                            <ComboBox x:Name="FourthStair" IsEnabled="{m:Exp Str=LoginUser.character ^ 4}" SelectedValue="{m:Bind Path=FourthStair}" Grid.Row="8" Grid.Column="1" ItemsSource="{m:Exp Str=FourthStairlist}"  Margin="0,3,0,2" DisplayMemberPath="name" SelectedValuePath="name"  Height="25" HorizontalAlignment="Stretch" Width="Auto">
                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="FourthStair"/>
                                </a:Data.Prop>
                            </ComboBox>
                            <TextBox Visibility="Collapsed" Text="{m:Bind Path=f_OrgStr}" Grid.Row="23" Grid.Column="3" Margin="0" TextWrapping="Wrap" IsReadOnly="True"  VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Height="Auto" Grid.RowSpan="1" >
                                <a:Data.Prop>
                                    <o:PropertySetter PropertyName="f_OrgStr" NotNull="True"
													NoDependValue="{m:Exp Str=$\{roadmanege.DataContext.FirstStair\}\{$.$\}\{roadmanege.DataContext.SecondStair\!\=null:roadmanege.DataContext.SecondStair\,$$\}\{$.$\}\{roadmanege.DataContext.ThirdStair\!\=null:roadmanege.DataContext.ThirdStair\,$$\}\{$.$\}\{roadmanege.DataContext.FourthStair\!\=null:roadmanege.DataContext.FourthStair\,$$\}$}"/>                                
                                </a:Data.Prop>
                            </TextBox>
                </Grid>
            </toolkit:DockPanel>
        </c:BusyIndicatorEx>
        <c:BusyIndicatorEx BusyContent="正在查询，请稍等" IsBusy="{m:Exp Str=roads.ItemsSource.IsBusy}" Grid.Column="1" >

            <toolkit:DockPanel toolkit:DockPanel.Dock="Top" >
                <Grid Background="{x:Null}" toolkit:DockPanel.Dock="Bottom" Margin="0" Height="27"  >
                    <sdk:DataPager x:Name="pager" Source="{Binding ItemsSource.Count, Converter={StaticResource DataPagerConverter}, ElementName=roads}"  Margin="0" PageSize="20" Height="24" VerticalAlignment="Bottom"/>
                    <TextBlock TextWrapping="Wrap" Text="{m:Exp Str=$共\{roads.ItemsSource.Count\}项}" Width="Auto" Height="27" HorizontalAlignment="Left" Foreground="#FF140000"/>
                </Grid>

                <Grid x:Name="roadsearch" toolkit:DockPanel.Dock="Top" Margin="0,0,0,5" Background="#FFDBE4F3"    >

                    <Grid.RowDefinitions>
                        <RowDefinition Height="28"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="69"/>
                        <ColumnDefinition Width="0.749*"/>
                        <ColumnDefinition Width="0.251*"/>
                    </Grid.ColumnDefinitions>
                    <a:Data.Context>
                        <o:SearchObject />
                    </a:Data.Context>

                    <TextBlock TextWrapping="Wrap" Text="街道名称：" Margin="0" Height="25" TextAlignment="Right" />
                    <TextBox TextWrapping="Wrap" Grid.Column="1" Text="{m:Bind Path=f_road}" Width="Auto" Margin="0,2,0,1" Height="25" >
                        <a:Data.Prop>
                            <o:PropertySetter PropertyName="f_road"  Operator="f_road like '%this%'" />
                        </a:Data.Prop>
                    </TextBox>
                    <Button Content="查询" Grid.Column="2" x:Name="searchbutton" Click="{m:Exp Str=roadsearch.DataContext.Search()}" Margin="5,0,0,3" HorizontalAlignment="Left" Width="70" Height="30" VerticalAlignment="Center" />
                </Grid>
                <sdk:DataGrid x:Name="roads" Margin="0"  IsReadOnly="True"
    					AutoGenerateColumns="False" Width="Auto" Background="{x:Null}" >
                    <a:Data.Items>
                        <!--userfile.DataContext.State\=\=$End$ or SaveAction.State\=\=$End$-->
                        <o:PagedObjectList x:Name="roadlist" WebClientInfo="{StaticResource dbclient}"
    							Path="{m:Exp Str=$from t_road where \{roadsearch.DataContext.Condition\} and  (f_OrgStr  like  \'\{LoginUser.orgpathstr\}\{$%$\}\')}"
    							IsOld="{m:Exp Str='roadsearch.DataContext.Condition\=\=$End$ or DeleteAction.State==$End$ |or| SaveAction.State==$End$'}"
    							PageIndex="{m:Exp Str=pager.PageIndex}" PageSize="{m:Exp Str=pager.PageSize}"  SumNames=","/>
                    </a:Data.Items>
                    <sdk:DataGrid.Columns>
                        <sdk:DataGridTextColumn d:IsLocked="True" Header="街道名称" Binding="{Binding f_road}"/>
                        <sdk:DataGridTextColumn d:IsLocked="True" Header="街道范围" Binding="{Binding f_roadrange}"/>
                        <sdk:DataGridTextColumn d:IsLocked="True" Header="操作日期" Binding="{Binding f_operatedate,StringFormat=yyyy-MM-dd}"/>
                        <sdk:DataGridTextColumn Header="操作员" Binding="{Binding f_operator}"/>
                    </sdk:DataGrid.Columns>
                </sdk:DataGrid>
            </toolkit:DockPanel>
        </c:BusyIndicatorEx>
    </Grid>
</UserControl>